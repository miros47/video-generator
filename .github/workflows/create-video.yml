name: Create Slideshow Video

on:
  repository_dispatch:
    types: [create-video]

jobs:
  create-video:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          ffmpeg -version

      - name: Download images and audio
        run: |
          mkdir -p workspace && cd workspace
          echo '${{ toJson(github.event.client_payload.scenes) }}' > scenes.json
          
          cat scenes.json | jq -r 'to_entries[] | "\(.key) \(.value.image_url)"' | while read idx url; do
            [ -n "$url" ] && [ "$url" != "null" ] && curl -sL -o "image_${idx}.jpg" "$url" && echo "âœ… Image $idx"
          done
          
          cat scenes.json | jq -r 'to_entries[] | "\(.key) \(.value.audio_url)"' | while read idx url; do
            [ -n "$url" ] && [ "$url" != "null" ] && curl -sL -o "audio_${idx}.mp3" "$url" && echo "âœ… Audio $idx"
          done
          
          ls -la

      - name: Merge audio files
        run: |
          cd workspace
          ls audio_*.mp3 2>/dev/null | sort -V | while read f; do echo "file '$f'"; done > audio_list.txt
          if [ -s audio_list.txt ]; then
            ffmpeg -f concat -safe 0 -i audio_list.txt -c copy merged_audio.mp3 -y
            echo "âœ… Audio merged"
          fi

      - name: Create slideshow with transitions
        run: |
          cd workspace
          DURATION=${{ github.event.client_payload.duration_per_image || 30 }}
          FADE=${{ github.event.client_payload.fade_duration || 1 }}
          
          for img in $(ls image_*.jpg 2>/dev/null | sort -V); do
            idx=$(echo "$img" | grep -oP '\d+')
            ffmpeg -loop 1 -i "$img" -c:v libx264 -t $DURATION -pix_fmt yuv420p \
              -vf "scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2,fade=t=in:st=0:d=$FADE,fade=t=out:st=$((DURATION-FADE)):d=$FADE" \
              -r 30 "clip_${idx}.mp4" -y
            echo "âœ… Clip $idx created"
          done
          
          ls clip_*.mp4 2>/dev/null | sort -V | while read f; do echo "file '$f'"; done > clips.txt
          ffmpeg -f concat -safe 0 -i clips.txt -c copy video_only.mp4 -y
          echo "âœ… Video created"

      - name: Add audio
        run: |
          cd workspace
          if [ -f merged_audio.mp3 ]; then
            ffmpeg -i video_only.mp4 -i merged_audio.mp3 -c:v copy -c:a aac -shortest final_video.mp4 -y
          else
            mv video_only.mp4 final_video.mp4
          fi
          echo "âœ… Final video ready"
          ls -lh final_video.mp4

      - name: Upload video
        id: upload
        run: |
          cd workspace
          echo "ðŸ“¤ Uploading video..."
          
          # transfer.sh kullan
          URL=$(curl --upload-file final_video.mp4 https://transfer.sh/video.mp4)
          
          echo "video_url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸŽ¬ Video URL: $URL"
